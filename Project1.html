<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project 1 – Oxygen Budget</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</head>
<body>
  <div class="sidebar">
    <img src="Logo_NS-blackboard-Expand.png" alt="Sidebar Image">
    <nav>
      <ul class="nav-menu">
        <li><a href="Welcome.html">Welcome to NFYK22003U</a></li>
        <li><a href="CourseInformation.html">Course Information</a></li>
        <li>
          <a href="#">Chapter 1</a>
          <ul class="sub-menu">
            <li><a href="Project1.html">Project 1 – Oxygen Budget</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </div>

  <div class="main-content">
    <h1>Project 1 – Oxygen Budget</h1>

    <p>We saw in class that the highest concentrations of dissolved inorganic carbon (DIC) are in the mid-depth Pacific ocean.</p>

    <ul>
      <li>In Absalon, under files, download <code>theocean.nc</code> and plot the global distribution of DIC at 2000m depth, in an east-west cut, and a north-south cut across the Pacific. The file contains output of a commonly used climate model (Nielsen et al. 2019, Paleoceanography). It helps to use <code>xarray</code>, and a primer for how to use it to analyze model simulations is provided at:  
        <a href="https://veros.readthedocs.io/en/latest/tutorial/analysis.html" target="_blank">https://veros.readthedocs.io/en/latest/tutorial/analysis.html</a>
      </li>
      <li>Use the Reynolds averaged tracer equation to determine the main sources and sinks of DIC in the mid-depth North Pacific (the values for horizontal and vertical turbulent diffusivity are 800 and 1-e5 m²/s, respectively). Pay attention to the units!</li>
      <li>Describe in your own words and based on your analysis above what explains the DIC maximum in the North Pacific.</li>
      <li>Form groups of 2 or 3 and hand in the answers as PDF by Sunday, midnight (i.e. email to <a href="mailto:mjochum@nbi.dk">mjochum@nbi.dk</a>).</li>
    </ul>

    <p>Check the current directory:</p>
    <div class="code-block">
      <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
      <pre><code class="language-python">!pwd</code></pre>
    </div>

    <p>List files in the current directory:</p>
    <div class="code-block">
      <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
      <pre><code class="language-python">!ls</code></pre>
    </div>

    <p>For example, if you want to check inside the erda_mount directory:</p>

    <div class="code-block">
      <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
      <pre><code class="language-python">!ls erda_mount/</code></pre>
    </div>

    <p>To inspect the NetCDF file <code>theocean.nc</code> located in the same folder as your notebook (<code>/home/jovyan/erda_mount</code>), you can do the following directly within a notebook cell:</p>
    <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">!ls /home/jovyan/erda_mount/theocean.nc # Verify the file exists first</code></pre>
      </div>

    <p>Quickly inspect the contents using Python and the <code>xarray</code> package, <a href="https://docs.xarray.dev/en/stable/user-guide/index.html">here</a> is a detailed user guide for it</p>
    <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">!pip install xarray</code></pre>
      </div>
    <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">import xarray as xr

# Open and inspect the NetCDF file
ds = xr.open_dataset('/home/jovyan/erda_mount/theocean.nc')

# Show dataset details
print(ds)

# Display variables specifically
print("\nData Variables:")
print(ds.data_vars)</code></pre>
      </div>

      <p>To check whether a specific variable (e.g., <code>DIC</code>) exists in an opened xarray dataset and retrieve detailed information about it, you can do the following:</p>
      <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">import xarray as xr

# Load the dataset
ds = xr.open_dataset('/home/jovyan/erda_mount/theocean.nc')

# Check if 'DIC' exists in the dataset
if 'DIC' in ds.variables:
    print("'DIC' variable found!\n")
    
    # Print detailed info about the 'DIC' variable
    print(ds['DIC'])
else:
    print("'DIC' variable not found in the dataset.") </code></pre>
      </div>
      <pre style="font-family: 'Courier New', Courier, monospace; color: #aaccee; background: transparent; border: none; padding: 1em 0; margin: 0;">
'DIC' variable found!

<xarray.DataArray 'DIC' (time: 1, z_t: 60, nlat: 116, nlon: 100)> Size: 3MB
[696000 values with dtype=float32]
Coordinates:
  * time     (time) object 8B 1950-07-16 21:59:59.999997
  * z_t      (z_t) float32 240B 500.0 1.5e+03 2.5e+03 ... 5.125e+05 5.375e+05
    ULONG    (nlat, nlon) float64 93kB ...
    ULAT     (nlat, nlon) float64 93kB ...
    TLONG    (nlat, nlon) float64 93kB ...
    TLAT     (nlat, nlon) float64 93kB ...
Dimensions without coordinates: nlat, nlon
Attributes:
    long_name:     Dissolved Inorganic Carbon
    units:         mmol/m^3
    grid_loc:      3111
    cell_methods:  time: mean
</pre>

<p>For printing all variables and their <code>long_name</code></p>
<div class="code-block">
    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
    <pre><code class="language-python">import xarray as xr

# Open the NetCDF file
ds = xr.open_dataset('/home/jovyan/erda_mount/theocean.nc')

# Print all variables and their long_name 
print("=== Variables and Their Descriptions ===\n")
for var in ds.variables:
    long_name = ds[var].attrs.get('long_name', 'No long_name')
    print(f"{var:20}: {long_name}")</code></pre>
  </div>
  <pre style="font-family: 'Courier New', Courier, monospace; color: #aaccee; background: transparent; border: none; padding: 1em 0; margin: 0;">
    === Variables and Their Descriptions ===

time_bound          : boundaries for time-averaging interval
moc_components      : MOC component names
transport_components: T,S transport components
transport_regions   : regions for all transport diagnostics
time                : time
z_t                 : depth from surface to midpoint of layer
z_t_150m            : depth from surface to midpoint of layer
z_w                 : depth from surface to top of layer
z_w_top             : depth from surface to top of layer
z_w_bot             : depth from surface to bottom of layer
lat_aux_grid        : latitude grid for transport diagnostics
moc_z               : depth from surface to top of layer
dz                  : thickness of layer k
dzw                 : midpoint of k to midpoint of k+1
ULONG               : array of u-grid longitudes
ULAT                : array of u-grid latitudes
TLONG               : array of t-grid longitudes
TLAT                : array of t-grid latitudes
    </pre>

<p>To print detailed metadata of each variable in a NetCDF file, 
    such as its data type, dimensions, and attributes (like long_name, units, _FillValue, missing_value, _ChunkSizes), 
    you can use the following code</p>
    <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">import xarray as xr

# Open dataset
ds = xr.open_dataset('/home/jovyan/erda_mount/theocean.nc')

# Loop through all variables
for var in ds.variables:
    da = ds[var]
    
    print(f"{da.dtype} {var}({', '.join(f'{dim}={ds.dims[dim]}' for dim in da.dims)});")
    
    for attr, val in da.attrs.items():
        print(f"  :{attr} = {val!r};")
    
    print()  # Blank line between variables</code></pre>
      </div>
      <pre style="font-family: 'Courier New', Courier, monospace; color: #aaccee; background: transparent; border: none; padding: 1em 0; margin: 0;">
object time_bound(time=1, d2=2);
:long_name = 'boundaries for time-averaging interval';
:cell_methods = 'time: mean';

|S256 moc_components(moc_comp=3);
  :long_name = 'MOC component names';
  :units = '';

|S256 transport_components(transport_comp=5);
  :long_name = 'T,S transport components';
  :units = '';

|S256 transport_regions(transport_reg=2);
  :long_name = 'regions for all transport diagnostics';
  :units = '';

object time(time=1);
  :long_name = 'time';
  :bounds = 'time_bound';
  :cell_methods = 'time: mean';

float32 z_t(z_t=60);
  :long_name = 'depth from surface to midpoint of layer';
  :units = 'centimeters';
  :positive = 'down';
  :valid_min = np.float32(500.0);
  :valid_max = np.float32(537500.0);

float32 z_t_150m(z_t_150m=15);
  :long_name = 'depth from surface to midpoint of layer';
  :units = 'centimeters';
  :positive = 'down';
  :valid_min = np.float32(500.0);
  :valid_max = np.float32(14500.0);

float32 z_w(z_w=60);
  :long_name = 'depth from surface to top of layer';
  :units = 'centimeters';
  :positive = 'down';
  :valid_min = np.float32(0.0);
  :valid_max = np.float32(525000.94);

float32 z_w_top(z_w_top=60);
  :long_name = 'depth from surface to top of layer';
  :units = 'centimeters';
  :positive = 'down';
  :valid_min = np.float32(0.0);
  :valid_max = np.float32(525000.94);

float32 z_w_bot(z_w_bot=60);
  :long_name = 'depth from surface to bottom of layer';
  :units = 'centimeters';
  :positive = 'down';
  :valid_min = np.float32(1000.0);
  :valid_max = np.float32(549999.06);

float32 lat_aux_grid(lat_aux_grid=105);
  :long_name = 'latitude grid for transport diagnostics';
  :units = 'degrees_north';
  :valid_min = np.float32(-80.26017);
  :valid_max = np.float32(90.0);

float32 moc_z(moc_z=61);
  :long_name = 'depth from surface to top of layer';
  :units = 'centimeters';
  :positive = 'down';
  :valid_min = np.float32(0.0);
  :valid_max = np.float32(549999.06);

float32 dz(z_t=60);
  :long_name = 'thickness of layer k';
  :units = 'centimeters';

float32 dzw(z_w=60);
  :long_name = 'midpoint of k to midpoint of k+1';
  :units = 'centimeters';

float64 ULONG(nlat=116, nlon=100);
  :long_name = 'array of u-grid longitudes';
  :units = 'degrees_east';

float64 ULAT(nlat=116, nlon=100);
  :long_name = 'array of u-grid latitudes';
  :units = 'degrees_north';

float64 TLONG(nlat=116, nlon=100);
  :long_name = 'array of t-grid longitudes';
  :units = 'degrees_east';

float64 TLAT(nlat=116, nlon=100);
  :long_name = 'array of t-grid latitudes';
  :units = 'degrees_north';
        </pre>


<p>But if you plot it directly, the projection might seem incorrect due to the lack of proper 
    geographic coordinates, suggest a need for proper coordinate projection handling (but this can be unnecessary depending on the goal and model).
     Based on the output, some effort regarding color bar handling is also needed for this assignment.</p>


<div class="code-block">
    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
    <pre><code class="language-python">import xarray as xr
import matplotlib.pyplot as plt

# Load the dataset
ds = xr.open_dataset('/home/jovyan/erda_mount/theocean.nc')

# Select surface DIC (assuming variable DIC is 4D: time, z, y, x)
surface_DIC = ds['DIC'].isel(time=-1, z_t=0)

# Plotting the map of sea surface DIC
fig, ax = plt.subplots(figsize=(6, 5), dpi = 300)
surface_DIC.plot.pcolormesh(
    ax=ax,
    cmap='coolwarm',  # choose colormap here
    shading='auto',
    cbar_kwargs={'label': 'DIC (mol m$^{-3}$)'}
)

ax.set_title('Sea Surface DIC')
ax.set_xlabel('Longitude')
ax.set_ylabel('Latitude')

plt.tight_layout()

# Save the figure at the save folder
plt.savefig('./sea_surface_DIC.png', transparent=True)

plt.show()</code></pre>
  </div>

  <img src="Figures/Project1_sea_surface_DIC.png" alt="Project1_sea_surface_DIC.png" style="margin-top: 1.5em; border: 1px solid #3c5c78; border-radius: 6px; max-width: 100%; display: block;">

  <p>Here's a quick cell you can run to inspect the coordinate system (dimensions, variable names, and their attributes) of your NetCDF file (<code>theocean.nc</code>)</p>
  <div class="code-block">
    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
    <pre><code class="language-python">import numpy as np

ds = xr.open_dataset('/home/jovyan/erda_mount/theocean.nc')

# Print coordinates specifically
print("\n--- Coordinate Variables ---")
for coord in ds.coords:
    print(f"{coord}: {ds.coords[coord].dims} {ds.coords[coord].shape}")

# Print variable names and their dimensions
print("\n--- Data Variables ---")
for var in ds.data_vars:
    print(f"{var}: {ds[var].dims} {ds[var].shape}")

# Print attributes of TLAT and TLONG if they exist
if 'TLAT' in ds:
    print("\nTLAT attributes:", ds['TLAT'].attrs)
if 'TLONG' in ds:
    print("\nTLONG attributes:", ds['TLONG'].attrs)

# Print random sample lat/lon points to verify
print("\n--- Sample Latitude and Longitude Points ---")
TLAT = ds['TLAT'].values
TLONG = ds['TLONG'].values

nlat, nlon = TLAT.shape
for _ in range(5):
    i = np.random.randint(0, nlat)
    j = np.random.randint(0, nlon)
    print(f"Index (i={i}, j={j}) -> Lat: {TLAT[i, j]:.2f}°, Lon: {TLONG[i, j]:.2f}°")</code></pre>
  </div>

  <pre style="font-family: 'Courier New', Courier, monospace; color: #aaccee; background: transparent; border: none; padding: 1em 0; margin: 0;">
--- Sample Latitude and Longitude Points ---
Index (i=98, j=26) -> Lat: 74.99°, Lon: 16.65°
Index (i=69, j=12) -> Lat: 21.58°, Lon: 6.38°
Index (i=54, j=6) -> Lat: 3.38°, Lon: 344.90°
Index (i=47, j=35) -> Lat: -0.90°, Lon: 89.30°
Index (i=50, j=94) -> Lat: 0.90°, Lon: 301.70°
    </pre>

<p>Convert the domain from <code>[0, 360]</code> to <code>[-180, 180]</code>, which is easier to interpret for many ocean regions.</p>
<div class="code-block">
    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
    <pre><code class="language-python"># Surface map (latitude-longitude at surface level z_t=0)
dic_surface = ds['DIC'].isel(time=time_index, z_t=0)
lat_2d = ds['TLAT'].values
lon_2d = ds['TLONG'].values
lon_2d = np.where(lon_2d > 180, lon_2d - 360, lon_2d)  # Convert to [-180, 180]</code></pre>
  </div>

<p>Choosing the appropriate colorbar normalization is important for accurately visualizing the range and structure of values in climate model output</p>
<div class="code-block">
  <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
  <pre><code class="language-python">import matplotlib.pyplot as plt
import numpy as np
from matplotlib import colors

# Create sample data
N = 100
X, Y = np.mgrid[-3:3:complex(0, N), -2:2:complex(0, N)]
Z1 = np.exp(-X**2 - Y**2)
Z2 = np.exp(-(X - 1)**2 - (Y - 1)**2)
Z = (Z1 - Z2) * 2

# Normalize options
vmin, vmax = -1.0, 1.0

norms = {
    'Linear': None,
    'LogNorm': colors.LogNorm(vmin=Z[Z > 0].min(), vmax=Z.max()),
    'PowerNorm (quartic γ=0.25)': colors.PowerNorm(gamma=0.25, vmin=vmin, vmax=vmax),
    'PowerNorm (γ=0.5)': colors.PowerNorm(gamma=0.5, vmin=vmin, vmax=vmax),
    'TwoSlopeNorm (center=0)': colors.TwoSlopeNorm(vmin=vmin, vcenter=0, vmax=vmax),
    'Quantile Bins': colors.BoundaryNorm(boundaries=np.quantile(Z, np.linspace(0, 1, 10)), ncolors=256)
}

# Plotting
plt.rcParams['text.color'] = '#d6ebff'
plt.rcParams['axes.labelcolor'] = '#d6ebff'
plt.rcParams['xtick.color'] = '#d6ebff'
plt.rcParams['ytick.color'] = '#d6ebff'
plt.rcParams['axes.edgecolor'] = '#d6ebff'

fig, axs = plt.subplots(nrows=3, ncols=2, figsize=(14, 12), dpi = 300)
axs = axs.ravel()
fig.patch.set_alpha(0)
for ax in axs:
    ax.set_facecolor('none')

for ax, (name, norm) in zip(axs, norms.items()):
    # LogNorm only works on positive values
    if name == 'LogNorm':
        pcm = ax.pcolormesh(X, Y, np.abs(Z), norm=norm, cmap='coolwarm', shading='auto')
    else:
        pcm = ax.pcolormesh(X, Y, Z, norm=norm, cmap='coolwarm', shading='auto')

    fig.colorbar(pcm, ax=ax)
    ax.set_title(name)
    ax.set_aspect('equal')

plt.suptitle("Colorbar Normalization Examples", fontsize=16)
plt.tight_layout(rect=[0, 0, 1, 0.97])
plt.show()</code></pre>
    <img src="Figures/Project1_Colorbar_Normalization_Examples.png" alt="Colorbar_Normalization_Examples.png" style="margin-top: 1.5em; border: 1px solid #3c5c78; border-radius: 6px; max-width: 100%; display: block;">
</div>







    <p><strong>Next</strong>: <a href="#">To be continued</a></p>
  </div>

  <div class="footer">
    Qi-fan based on the course material by Markus Jochum & Marta Mrozowska <br>
    It is very much a work in progress! Have you spotted a mistake or an error on this page? 
    Click <a href="mailto:qifan.wu@nbi.ku.dk">here</a> to tell me!<br>
    &copy; 2025 TeamOcean | NBI/KU
  </div>

  <script>
    function copyToClipboard(btn) {
      const code = btn.nextElementSibling.innerText;
      navigator.clipboard.writeText(code).then(() => {
        btn.classList.add('copied');
        setTimeout(() => btn.classList.remove('copied'), 2000);
      });
    }
  </script>
</body>
</html>
